name: Sync Upstream
on:
  schedule: [{ cron: '0 0 * * *' }]
  workflow_dispatch:
permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge upstream/main into main (prefer upstream on conflicts)
        run: |
          git config user.name  "ilf-S"
          git config user.email "ilf-S@users.noreply.github.com"
          git remote get-url upstream >/dev/null 2>&1 || git remote add upstream https://github.com/FreeCAD/FreeCAD.git
          git fetch upstream --prune
          git checkout main
          git merge --ff-only upstream/main || git merge --no-edit -X theirs upstream/main

      - name: Drop upstream CI (keep only this workflow)
        env: { SELF_FILE: .github/workflows/sync.yml }
        run: |
          mkdir -p .github/workflows
          find .github/workflows -type f ! -name "$(basename "$SELF_FILE")" -delete
          rm -f .github/dependabot.yml || true
          rm -rf .devcontainer || true
          git add -A

      - name: Commit & push once (skip other Actions; COPR webhook still fires)
        run: |
          if ! git diff --cached --quiet; then
            d="$(date -u +%F)"
            git commit -m "sync: upstream ${d} [skip ci]"
            git push origin main
          else
            echo "No changes."
          fi
